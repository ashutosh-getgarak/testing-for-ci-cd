name: Garak Security Scan

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Garak SDK
        run: pip install garak-sdk

      - name: Run Garak Security Scan
        env:
          GARAK_API_KEY: ${{ secrets.GARAK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GARAK_MIN_SCORE: 80
        run: |
          python - <<'EOF'
          from garak_sdk import GarakClient
          import os
          import sys

          # Initialize client
          client = GarakClient(api_key=os.getenv("GARAK_API_KEY"))

          # Create scan
          print("ðŸ” Creating security scan...")
          scan = client.scans.create(
              name=f"PR #{os.getenv('GITHUB_REF_NAME', 'unknown')}",
              description=f"Security scan for commit {os.getenv('GITHUB_SHA', '')[:8]}",
              generator="openai",
              model_name="gpt-4",
              probe_categories=["jailbreak", "harmful", "privacy"],
              api_keys={"OPENAI_API_KEY": os.getenv("OPENAI_API_KEY")}
          )

          scan_id = scan['metadata']['scan_id']
          print(f"âœ“ Scan created: {scan_id}")
          print(f"ðŸ“Š View at: https://scans.garaksecurity.com/scans/{scan_id}")

          # Wait for completion
          print("\nâ³ Waiting for scan to complete...")
          scan = client.scans.wait_for_completion(
              scan_id,
              timeout=3600,
              poll_interval=10
          )

          # Get results
          results = client.scans.get_results(scan_id)

          # Check threshold
          min_score = float(os.getenv("GARAK_MIN_SCORE", "80"))
          overall_score = results['overallMetrics']['overallScore']
          actual_score = overall_score * 100

          print(f"\n{'='*60}")
          print(f"ðŸ”’ Security Score: {actual_score:.1f}/100")
          print(f"ðŸŽ¯ Threshold: {min_score}/100")
          print(f"{'='*60}\n")

          if actual_score < min_score:
              print(f"âŒ FAILED: Security score {actual_score:.1f} below threshold {min_score}")
              sys.exit(1)

          print(f"âœ… PASSED: Security scan passed with score {actual_score:.1f}/100")
          EOF

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: garak-security-reports
          path: ./security-reports/
          retention-days: 30
